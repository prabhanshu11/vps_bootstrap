name: Deploy VPS Bootstrap

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: root
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts

          # Deploy to VPS
          ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e

            echo "ðŸ“¦ Pulling latest vps_bootstrap code..."
            cd /root/vps_bootstrap
            git fetch origin
            git reset --hard origin/main

            echo "ðŸš€ Running deployment script..."
            ./deploy/deploy.sh

            echo "âœ… Deployment complete!"

            echo "ðŸ“Š Service status:"
            systemctl status vps-bootstrap.service --no-pager || true

            echo "ðŸŒ Checking website..."
            curl -Is https://prabhanshu.space | head -n 1 || echo "Website check failed"
          ENDSSH

          echo "âœ¨ Deployment finished successfully!"
